version: 1

env:
  runtime-versions:
    nodejs: 20 

backend:
  phases:
    install:
      commands:
        - 'export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] || curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash'
        - '. "$NVM_DIR/nvm.sh" 
        - nvm install 20.19.3 
        - nvm use 20.19.3'
        - node -v && npm -v
        - export NPM_CONFIG_PRODUCTION=false   
        - npm ci --no-audit --no-fund
    build:
      commands:
        - '. "$NVM_DIR/nvm.sh" && nvm install 20.19.3 && nvm use 20.19.3'
        - node -v && npm -v
        
        - npm config get production
        - [ -f amplify/tsconfig.json ] && echo "amplify tsconfig present"
        - ls -la node_modules/@aws-amplify || ls -la amplify/node_modules/@aws-amplify
        - npx -y @aws-amplify/backend-cli@1.8.0 pipeline-deploy --branch "$AWS_BRANCH" --app-id "$AWS_APP_ID" --outputs-out-dir ./src --outputs-version 1.4 --outputs-format json

frontend:
  phases:
    install:
      commands:
        - '. "$NVM_DIR/nvm.sh" && nvm install 20.19.3 && nvm use 20.19.3'
        - node -v && npm -v
        - npm ci --no-audit --no-fund
    build:
      commands:
        - '. "$NVM_DIR/nvm.sh" && nvm install 20.19.3 && nvm use 20.19.3'
        - node -v && npm -v
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
