version: 1

env:
  runtime-versions:
    nodejs: 20

backend:
  phases:
    install:
      commands:
        - '. "$NVM_DIR/nvm.sh" && nvm install 20.19.3 && nvm use 20.19.3'
        - echo "BACKEND.install PWD=$(pwd)"; ls -la
        - cd amplify && npm ci --no-audit --no-fund && ls -la node_modules/@aws-amplify && cd ..
    build:
      commands:
        - '. "$NVM_DIR/nvm.sh" && nvm install 20.19.3 && nvm use 20.19.3'
        - echo "BACKEND.build PWD=$(pwd)"; ls -la amplify/node_modules/@aws-amplify
        - npx -y @aws-amplify/backend-cli@1.8.0 pipeline-deploy --branch "$AWS_BRANCH" --app-id "$AWS_APP_ID" --outputs-out-dir ./src --outputs-version 1.4 --outputs-format json

frontend:
  phases:
    install:
      commands:
        - '. "$NVM_DIR/nvm.sh" && nvm install 20.19.3 && nvm use 20.19.3'
        - node -v && npm -v
        - npm ci --no-audit --no-fund
    build:
      commands:
        - '. "$NVM_DIR/nvm.sh" && nvm install 20.19.3 && nvm use 20.19.3'
        - node -v && npm -v
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'

