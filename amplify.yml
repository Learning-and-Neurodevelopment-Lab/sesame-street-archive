version: 1
env:
  runtime-versions:
    nodejs: 20 

backend:
  phases:
    install:
      commands:
        - node -v && npm -v
        - export NPM_CONFIG_PRODUCTION=false

        - npm ci --no-audit --no-fund
    build:
      commands:
        - node -v && npm -v
        - echo "AWS_APP_ID=${AWS_APP_ID}  AWS_BRANCH=${AWS_BRANCH}"
        - [ -z "$AWS_APP_ID" ] 
        - [ -z "$AWS_BRANCH" ] 
        - ls node_modules/@aws-amplify | cat

        - npx -y @aws-amplify/backend-cli@1.8.0 --version
        - npx -y @aws-amplify/backend-cli@1.8.0 pipeline-deploy \
            --branch "$AWS_BRANCH" \
            --app-id "$AWS_APP_ID" \
            --outputs-out-dir ./src \
            --outputs-version 1.4 \
            --outputs-format json
frontend:
  phases:
    install:
      commands:
        - node -v && npm -v
        - npm install --no-audit --no-fund
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'

